

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>pymapmanager.mmMap &mdash; PyMapManager a1 documentation</title>
  

  
  
  
  

  

  
  
    

  

  
  
    <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
  

  

  
    <link rel="top" title="PyMapManager a1 documentation" href="../../index.html"/>
        <link rel="up" title="Module code" href="../index.html"/> 

  
  <script src="../../_static/js/modernizr.min.js"></script>

</head>

<body class="wy-body-for-nav" role="document">

   
  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search">
          

          
            <a href="../../index.html" class="icon icon-home"> PyMapManager
          

          
          </a>

          
            
            
              <div class="version">
                Version 0a1
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <!-- Local TOC -->
              <div class="local-toc"></div>
            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">PyMapManager</a>
        
      </nav>


      
      <div class="wy-nav-content">
        <div class="rst-content">
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../index.html">Docs</a> &raquo;</li>
        
          <li><a href="../index.html">Module code</a> &raquo;</li>
        
      <li>pymapmanager.mmMap</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <h1>Source code for pymapmanager.mmMap</h1><div class="highlight"><pre>
<span></span><span class="kn">import</span> <span class="nn">os</span><span class="o">,</span> <span class="nn">io</span><span class="o">,</span> <span class="nn">time</span><span class="o">,</span> <span class="nn">math</span>
<span class="kn">from</span> <span class="nn">errno</span> <span class="k">import</span> <span class="n">ENOENT</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>

<span class="kn">from</span> <span class="nn">pymapmanager.mmUtil</span> <span class="k">import</span> <span class="n">ROI_TYPES</span><span class="p">,</span> <span class="n">newplotdict</span>
<span class="kn">from</span> <span class="nn">pymapmanager.mmStack</span> <span class="k">import</span> <span class="n">mmStack</span>
<span class="kn">from</span> <span class="nn">pymapmanager.mmio</span> <span class="k">import</span> <span class="n">mmio</span>

<span class="sd">&#39;&#39;&#39;3D numpy array, rows are stack centric indices, columns are sessions, 3rd dimension is:</span>
<span class="sd">	[0] idx, [1] next, [2] nextTP, [3] prev, [4] prevTP</span>
<span class="sd">	[5] blank, [6] runIdx, [7] dynType, [8] forced</span>
<span class="sd">	[9] nodeType, [10] segmentID, [11] splitIdx</span>
<span class="sd">&#39;&#39;&#39;</span>

<div class="viewcode-block" id="mmMap"><a class="viewcode-back" href="../../pymapmanager.mmMap.html#pymapmanager.mmMap.mmMap">[docs]</a><span class="k">class</span> <span class="nc">mmMap</span><span class="p">():</span>
	<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">	A time-series of :class:`pymapmanager.mmStack` plus some book-keeping to link corresponding annotations</span>
<span class="sd">	and segments between stacks.</span>

<span class="sd">	Args:</span>
<span class="sd">		filePath (str): Full file path to .txt file for the map. File is inside map folder, for map a5n it is /a5n/a5n.txt</span>
<span class="sd">		urlmap (str): Name of the map to load from a :class:`pymapmanager.mmio` online repository.</span>

<span class="sd">	Example::</span>

<span class="sd">		from pymapmanager.mmMap import mmMap</span>
<span class="sd">		file = &#39;/Users/cudmore/Desktop/data/cudmore/rr30a/rr30a.txt&#39;</span>
<span class="sd">		m = mmMap(filePath=path)</span>

<span class="sd">		# Get the 3rd mmStack using</span>
<span class="sd">		stack = m.stacks[3]</span>

<span class="sd">		# Use getMapValues2() to retrieve stack annotations (for the given segmentID) across the entire map</span>
<span class="sd">		pDist_values = m.getMapValues2(&#39;pDist&#39;, segmentID=[3])</span>
<span class="sd">	&quot;&quot;&quot;</span>

	<span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filePath</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">urlmap</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
		<span class="n">startTime</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>

		<span class="bp">self</span><span class="o">.</span><span class="n">filePath</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
		<span class="c1"># Full file path to .txt file for the map.</span>

		<span class="bp">self</span><span class="o">.</span><span class="n">_folder</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
		<span class="c1"># Path to enclosing folder, ends in &#39;/&#39;.</span>

		<span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
		<span class="c1"># Name of the map. For a map loaded with file a5n.txt, name is a5b. Same as enclosing folder name.</span>
		<span class="c1"># If urlmap then this is the name of the map to fetch from a :class:`pymapmanager.mmio` server.</span>

		<span class="bp">self</span><span class="o">.</span><span class="n">table</span> <span class="o">=</span> <span class="kc">None</span>
		<span class="c1"># Pandas dataframe loaded from .txt file filePath or &#39;header&#39; if using :class:`pymapmanager.mmio`.</span>
		<span class="c1"># Get values from this dataframe using getValue(name,sessionNumber)</span>

		<span class="bp">self</span><span class="o">.</span><span class="n">defaultRoiType</span> <span class="o">=</span> <span class="s1">&#39;spineROI&#39;</span>

		<span class="bp">self</span><span class="o">.</span><span class="n">server</span> <span class="o">=</span> <span class="kc">None</span>
		<span class="c1"># Pointer to :class:`pymapmanager.mmio` server connection.</span>
		<span class="c1"># Only used to load from urlmap.</span>

		<span class="bp">self</span><span class="o">.</span><span class="n">objMap</span> <span class="o">=</span> <span class="kc">None</span>
		<span class="c1"># 2D array where each row is a run of annotations.</span>
		<span class="c1"># objMap[i][j] gives us a mmStack centric index into mmStack.stackdb.</span>

		<span class="bp">self</span><span class="o">.</span><span class="n">segMap</span> <span class="o">=</span> <span class="kc">None</span>
		<span class="c1"># 2D array where each row is a run of segments.</span>
		<span class="c1"># segMap[i][j] gives us mmStack centric index into mmStack._line</span>

		<span class="n">doFile</span> <span class="o">=</span> <span class="kc">True</span>
		<span class="k">if</span> <span class="n">filePath</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
			<span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">filePath</span><span class="p">):</span>
				<span class="k">raise</span> <span class="ne">IOError</span><span class="p">(</span><span class="n">ENOENT</span><span class="p">,</span> <span class="s1">&#39;mmMap did not find filePath:&#39;</span><span class="p">,</span> <span class="n">filePath</span><span class="p">)</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">filePath</span> <span class="o">=</span> <span class="n">filePath</span> <span class="c1">#  Path to file used to open map.&quot;&quot;&quot;</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">_folder</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">filePath</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;/&#39;</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">filePath</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s1">&#39;.txt&#39;</span><span class="p">)</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">table</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_table</span><span class="p">(</span><span class="n">filePath</span><span class="p">,</span> <span class="n">index_col</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
		<span class="k">elif</span> <span class="n">urlmap</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
			<span class="n">doFile</span> <span class="o">=</span> <span class="kc">False</span>
			<span class="c1"># try loading from url</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">urlmap</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">server</span> <span class="o">=</span> <span class="n">mmio</span><span class="o">.</span><span class="n">mmio</span><span class="p">()</span>
			<span class="n">tmp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">server</span><span class="o">.</span><span class="n">getfile</span><span class="p">(</span><span class="s1">&#39;header&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">table</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_table</span><span class="p">(</span><span class="n">io</span><span class="o">.</span><span class="n">StringIO</span><span class="p">(</span><span class="n">tmp</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)),</span> <span class="n">index_col</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

		<span class="c1">###############################################################################</span>
		<span class="c1"># objMap (3d)</span>
		<span class="k">if</span> <span class="n">doFile</span><span class="p">:</span>
			<span class="n">objMapFile</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_folder</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">+</span> <span class="s1">&#39;_objMap.txt&#39;</span>
			<span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">objMapFile</span><span class="p">):</span>
				<span class="k">raise</span> <span class="ne">IOError</span><span class="p">(</span><span class="n">ENOENT</span><span class="p">,</span> <span class="s1">&#39;mmMap did not find objMapFile:&#39;</span><span class="p">,</span> <span class="n">objMapFile</span><span class="p">)</span>
			<span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">objMapFile</span><span class="p">,</span> <span class="s1">&#39;rU&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
				<span class="n">header</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span><span class="o">.</span><span class="n">rstrip</span><span class="p">()</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">objMap</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">loadtxt</span><span class="p">(</span><span class="n">objMapFile</span><span class="p">,</span> <span class="n">skiprows</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
		<span class="k">else</span><span class="p">:</span>
			<span class="n">tmp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">server</span><span class="o">.</span><span class="n">getfile</span><span class="p">(</span><span class="s1">&#39;objmap&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
			<span class="n">header</span> <span class="o">=</span> <span class="n">tmp</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">objMap</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">loadtxt</span><span class="p">(</span><span class="n">tmp</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">),</span> <span class="n">skiprows</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

		<span class="k">if</span> <span class="n">header</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;;&#39;</span><span class="p">):</span>
			<span class="n">header</span> <span class="o">=</span> <span class="n">header</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
		<span class="n">header</span> <span class="o">=</span> <span class="n">header</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;;&#39;</span><span class="p">)</span>
		<span class="n">d</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;=&#39;</span><span class="p">)</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">header</span><span class="p">)</span>
		<span class="n">numRow</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">d</span><span class="p">[</span><span class="s1">&#39;rows&#39;</span><span class="p">])</span>
		<span class="n">numCol</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">d</span><span class="p">[</span><span class="s1">&#39;cols&#39;</span><span class="p">])</span>
		<span class="n">numBlock</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">d</span><span class="p">[</span><span class="s1">&#39;blocks&#39;</span><span class="p">])</span>

		<span class="bp">self</span><span class="o">.</span><span class="n">objMap</span><span class="o">.</span><span class="n">resize</span><span class="p">(</span><span class="n">numBlock</span><span class="p">,</span><span class="n">numRow</span><span class="p">,</span><span class="n">numCol</span><span class="p">)</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">runMap</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_buildRunMap</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">objMap</span><span class="p">)</span>

		<span class="c1">###############################################################################</span>
		<span class="c1"># segMap (3d)</span>
		<span class="n">header</span> <span class="o">=</span> <span class="kc">None</span>
		<span class="k">if</span> <span class="n">doFile</span><span class="p">:</span>
			<span class="n">segMapFile</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_folder</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">+</span> <span class="s1">&#39;_segMap.txt&#39;</span>
			<span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">segMapFile</span><span class="p">):</span>
				<span class="k">raise</span> <span class="ne">IOError</span><span class="p">(</span><span class="n">ENOENT</span><span class="p">,</span> <span class="s1">&#39;mmMap did not find segMapFile:&#39;</span><span class="p">,</span> <span class="n">segMapFile</span><span class="p">)</span>
			<span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">segMapFile</span><span class="p">,</span> <span class="s1">&#39;rU&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
				<span class="n">header</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span><span class="o">.</span><span class="n">rstrip</span><span class="p">()</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">segMap</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">loadtxt</span><span class="p">(</span><span class="n">segMapFile</span><span class="p">,</span> <span class="n">skiprows</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
		<span class="k">else</span><span class="p">:</span>
			<span class="n">tmp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">server</span><span class="o">.</span><span class="n">getfile</span><span class="p">(</span><span class="s1">&#39;segmap&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
			<span class="c1">#header = tmp.split(&#39;\r&#39;)[0] # works when server is running on OSX</span>
			<span class="n">header</span> <span class="o">=</span> <span class="n">tmp</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">segMap</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">loadtxt</span><span class="p">(</span><span class="n">tmp</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">),</span> <span class="n">skiprows</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

		<span class="k">if</span> <span class="n">header</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
			<span class="k">if</span> <span class="n">header</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;;&#39;</span><span class="p">):</span>
				<span class="n">header</span> <span class="o">=</span> <span class="n">header</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
			<span class="n">header</span> <span class="o">=</span> <span class="n">header</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;;&#39;</span><span class="p">)</span>
			<span class="n">d</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;=&#39;</span><span class="p">)</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">header</span><span class="p">)</span>
			<span class="n">numRow</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">d</span><span class="p">[</span><span class="s1">&#39;rows&#39;</span><span class="p">])</span>
			<span class="n">numCol</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">d</span><span class="p">[</span><span class="s1">&#39;cols&#39;</span><span class="p">])</span>
			<span class="n">numBlock</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">d</span><span class="p">[</span><span class="s1">&#39;blocks&#39;</span><span class="p">])</span>

			<span class="bp">self</span><span class="o">.</span><span class="n">segMap</span><span class="o">.</span><span class="n">resize</span><span class="p">(</span><span class="n">numBlock</span><span class="p">,</span><span class="n">numRow</span><span class="p">,</span><span class="n">numCol</span><span class="p">)</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">segRunMap</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_buildRunMap</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">segMap</span><span class="p">)</span>

		<span class="c1">###############################################################################</span>
		<span class="c1">#load each stack db</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">_stacks</span> <span class="o">=</span> <span class="p">[]</span> <span class="c1">#  A list of mmStack</span>
		<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">numSessions</span><span class="p">):</span>
			<span class="k">if</span> <span class="n">doFile</span><span class="p">:</span>
				<span class="n">stack</span> <span class="o">=</span> <span class="n">mmStack</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_getStackName</span><span class="p">(</span><span class="n">i</span><span class="p">),</span> <span class="n">numChannels</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">numChannels</span><span class="p">,</span> \
								<span class="nb">map</span><span class="o">=</span><span class="bp">self</span><span class="p">,</span> <span class="n">mapSession</span><span class="o">=</span><span class="n">i</span><span class="p">)</span>
			<span class="k">else</span><span class="p">:</span>
				<span class="n">stack</span> <span class="o">=</span> <span class="n">mmStack</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_getStackName</span><span class="p">(</span><span class="n">i</span><span class="p">),</span> <span class="n">numChannels</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">numChannels</span><span class="p">,</span> \
								<span class="nb">map</span><span class="o">=</span><span class="bp">self</span><span class="p">,</span> <span class="n">mapSession</span><span class="o">=</span><span class="n">i</span><span class="p">,</span> <span class="n">urlmap</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">stacks</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">stack</span><span class="p">)</span>

		<span class="n">stopTime</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
		<span class="nb">print</span> <span class="s1">&#39;map&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="s1">&#39;loaded in&#39;</span><span class="p">,</span> <span class="nb">round</span><span class="p">(</span><span class="n">stopTime</span><span class="o">-</span><span class="n">startTime</span><span class="p">,</span><span class="mi">2</span><span class="p">),</span> <span class="s1">&#39;seconds.&#39;</span>

	<span class="nd">@property</span>
	<span class="k">def</span> <span class="nf">numChannels</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
		<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">		Number of image channels in each stack (must be the same for all stacks).</span>
<span class="sd">		&quot;&quot;&quot;</span>
		<span class="k">return</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">getValue</span><span class="p">(</span><span class="s1">&#39;numChannels&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>

	<span class="nd">@property</span>
	<span class="k">def</span> <span class="nf">numSessions</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
		<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">			Number of sessions (timepoints) in the map (time-series).</span>
<span class="sd">		&quot;&quot;&quot;</span>
		<span class="k">return</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">table</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="s1">&#39;hsStack&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">count</span><span class="p">())</span>

	<span class="nd">@property</span>
	<span class="k">def</span> <span class="nf">stacks</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
		<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">		List of :class:`pymapmanager.mmStack` in the map.</span>
<span class="sd">		&quot;&quot;&quot;</span>
		<span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_stacks</span>

	<span class="nd">@property</span>
	<span class="k">def</span> <span class="nf">numMapSegments</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
		<span class="sd">&quot;&quot;&quot;The number of line segments in the map.</span>
<span class="sd">		Corresponding segments are connected together with the segMap.</span>
<span class="sd">		&quot;&quot;&quot;</span>
		<span class="n">numSegments</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">segRunMap</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
		<span class="k">return</span> <span class="n">numSegments</span>

	<span class="k">def</span> <span class="nf">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
		<span class="n">objCount</span> <span class="o">=</span> <span class="mi">0</span>
		<span class="k">for</span> <span class="n">stack</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">stacks</span><span class="p">:</span>
			<span class="n">objCount</span> <span class="o">+=</span> <span class="n">stack</span><span class="o">.</span><span class="n">numObj</span>
		<span class="k">return</span> <span class="p">(</span><span class="s1">&#39;map:&#39;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span>
			<span class="o">+</span> <span class="s1">&#39; map segments:&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">numMapSegments</span><span class="p">)</span>
			<span class="o">+</span> <span class="s1">&#39; stacks:&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">numSessions</span><span class="p">)</span>
			<span class="o">+</span> <span class="s1">&#39; total object:&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">objCount</span><span class="p">))</span>

	<span class="k">def</span> <span class="nf">__iter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
		<span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>
		<span class="k">while</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">stacks</span><span class="p">):</span>
			<span class="k">yield</span> <span class="bp">self</span><span class="o">.</span><span class="n">stacks</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
			<span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>

<div class="viewcode-block" id="mmMap.getValue"><a class="viewcode-back" href="../../pymapmanager.mmMap.html#pymapmanager.mmMap.mmMap.getValue">[docs]</a>	<span class="k">def</span> <span class="nf">getValue</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">sessionNumber</span><span class="p">):</span>
		<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">		Get a value from the map (not from a stack!).</span>

<span class="sd">		Args:</span>
<span class="sd">			name: Name of map value</span>
<span class="sd">			sessionNumber: Session number of the stack</span>

<span class="sd">		Returns:</span>
<span class="sd">			Str (this is a single value)</span>

<span class="sd">		Examples::</span>

<span class="sd">			m.getValue(&#39;pixelsz&#39;, 2) # get the number of z-slices (pixels) of stack 2.</span>
<span class="sd">			m.getValue(&#39;voxelx&#39;, 5) # get the x voxel size of stack 5 (in um/pixel).</span>
<span class="sd">			m.getValue(&#39;hsStack&#39;,3) # get the name of stack 3.</span>
<span class="sd">		&quot;&quot;&quot;</span>
		<span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">table</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">name</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">sessionNumber</span><span class="p">]</span> <span class="c1"># .loc specifies row, .iloc specifies a column</span></div>

	<span class="k">def</span> <span class="nf">_getStackName</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sessIdx</span><span class="p">):</span>
		<span class="c1"># get the name of the stack at session sessIdx, this is contained in the map header</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getValue</span><span class="p">(</span><span class="s1">&#39;hsStack&#39;</span><span class="p">,</span> <span class="n">sessIdx</span><span class="p">)</span>
		<span class="k">if</span> <span class="n">ret</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;_ch1&#39;</span><span class="p">):</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">ret</span><span class="p">[:</span><span class="o">-</span><span class="mi">4</span><span class="p">]</span>
		<span class="k">return</span> <span class="n">ret</span>

<div class="viewcode-block" id="mmMap.getMapValues3"><a class="viewcode-back" href="../../pymapmanager.mmMap.html#pymapmanager.mmMap.mmMap.getMapValues3">[docs]</a>	<span class="k">def</span> <span class="nf">getMapValues3</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pd</span><span class="p">):</span>
		<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">		Get values of a stack annotation across all stacks in the map.</span>

<span class="sd">		Args:</span>
<span class="sd">			pd (dict): A plot dictionary describing what to plot. Get default from mmUtil.newplotdict().</span>

<span class="sd">		Returns:</span>

<span class="sd">			| pd[&#39;x&#39;], 2D ndarray of xstat values, rows are runs, cols are sessions, nan is where there is no stackdb annotation</span>
<span class="sd">			| pd[&#39;y&#39;], same</span>
<span class="sd">			| pd[&#39;z&#39;], same</span>
<span class="sd">			| pd[&#39;stackidx&#39;], Each [i]j[] gives the stack centric index of annotation value at [i][j].</span>
<span class="sd">			| pd[&#39;mapsess&#39;], Each [i][j] gives the map session of value at annotation [i][j].</span>
<span class="sd">			| pd[&#39;runrow&#39;],</span>

<span class="sd">		&quot;&quot;&quot;</span>
		<span class="n">startTime</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>

		<span class="c1"># make sure pd[&#39;roitype&#39;] is a list</span>
		<span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">pd</span><span class="p">[</span><span class="s1">&#39;roitype&#39;</span><span class="p">],</span> <span class="nb">list</span><span class="p">):</span>
			<span class="n">pd</span><span class="p">[</span><span class="s1">&#39;roitype&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">pd</span><span class="p">[</span><span class="s1">&#39;roitype&#39;</span><span class="p">]]</span>

		<span class="n">m</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">runMap</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
		<span class="n">n</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">runMap</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>

		<span class="k">if</span> <span class="n">pd</span><span class="p">[</span><span class="s1">&#39;xstat&#39;</span><span class="p">]:</span>
			<span class="n">pd</span><span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">([</span><span class="n">m</span><span class="p">,</span> <span class="n">n</span><span class="p">])</span>
			<span class="n">pd</span><span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">][:]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">NAN</span>
		<span class="k">if</span> <span class="n">pd</span><span class="p">[</span><span class="s1">&#39;ystat&#39;</span><span class="p">]:</span>
			<span class="n">pd</span><span class="p">[</span><span class="s1">&#39;y&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">([</span><span class="n">m</span><span class="p">,</span> <span class="n">n</span><span class="p">])</span>
			<span class="n">pd</span><span class="p">[</span><span class="s1">&#39;y&#39;</span><span class="p">][:]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">NAN</span>
		<span class="k">if</span> <span class="n">pd</span><span class="p">[</span><span class="s1">&#39;zstat&#39;</span><span class="p">]:</span>
			<span class="n">pd</span><span class="p">[</span><span class="s1">&#39;z&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">([</span><span class="n">m</span><span class="p">,</span> <span class="n">n</span><span class="p">])</span>
			<span class="n">pd</span><span class="p">[</span><span class="s1">&#39;z&#39;</span><span class="p">][:]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">NAN</span>

		<span class="c1"># keep track of stack centric index we are plotting</span>
		<span class="n">yIdx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">([</span><span class="n">m</span><span class="p">,</span> <span class="n">n</span><span class="p">])</span>
		<span class="n">yIdx</span><span class="p">[:]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">NAN</span>

		<span class="c1"># keep track of session index</span>
		<span class="n">ySess</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">([</span><span class="n">m</span><span class="p">,</span> <span class="n">n</span><span class="p">])</span>
		<span class="n">ySess</span><span class="p">[:]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">NAN</span>

		<span class="c1"># keep track of run map rows (we already know the session/column)</span>
		<span class="n">yRunRow</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">([</span><span class="n">m</span><span class="p">,</span> <span class="n">n</span><span class="p">])</span>
		<span class="n">yRunRow</span><span class="p">[:]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">NAN</span>

		<span class="n">runIdxDim</span> <span class="o">=</span> <span class="mi">6</span>

		<span class="k">if</span> <span class="n">pd</span><span class="p">[</span><span class="s1">&#39;stacklist&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">pd</span><span class="p">[</span><span class="s1">&#39;stacklist&#39;</span><span class="p">])</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">:</span>
			<span class="n">myRange</span> <span class="o">=</span> <span class="n">pd</span><span class="p">[</span><span class="s1">&#39;stacklist&#39;</span><span class="p">]</span>
		<span class="k">else</span><span class="p">:</span>
			<span class="n">myRange</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="p">)</span>

		<span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">myRange</span><span class="p">:</span>
			<span class="n">orig_df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">stacks</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">stackdb</span>

			<span class="n">currSegmentID</span> <span class="o">=</span> <span class="p">[]</span>
			<span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">numMapSegments</span><span class="p">:</span>
				<span class="k">if</span> <span class="n">pd</span><span class="p">[</span><span class="s1">&#39;segmentid&#39;</span><span class="p">]:</span>
					<span class="n">currSegmentID</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">segRunMap</span><span class="p">[</span><span class="n">pd</span><span class="p">[</span><span class="s1">&#39;segmentid&#39;</span><span class="p">],</span> <span class="n">j</span><span class="p">]</span>  <span class="c1"># this only works for one segment -- NOT A LIST</span>
					<span class="n">currSegmentID</span> <span class="o">=</span> <span class="n">currSegmentID</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
				<span class="k">if</span> <span class="n">pd</span><span class="p">[</span><span class="s1">&#39;segmentid&#39;</span><span class="p">]</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">currSegmentID</span><span class="p">:</span>
					<span class="c1"># this session does not have segmentID that match</span>
					<span class="k">break</span>

			<span class="n">goodIdx</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">runMap</span><span class="p">[:,</span> <span class="n">j</span><span class="p">]</span>  <span class="c1"># valid indices from runMap</span>

			<span class="n">runMap_idx</span> <span class="o">=</span> <span class="n">orig_df</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">goodIdx</span><span class="p">)</span>  <span class="c1"># series of boolean (Seems to play nice with nparray)</span>

			<span class="k">if</span> <span class="n">pd</span><span class="p">[</span><span class="s1">&#39;roitype&#39;</span><span class="p">]:</span>
				<span class="n">roiType_idx</span> <span class="o">=</span> <span class="n">orig_df</span><span class="p">[</span><span class="s1">&#39;roiType&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">pd</span><span class="p">[</span><span class="s1">&#39;roitype&#39;</span><span class="p">])</span>
				<span class="n">runMap_idx</span> <span class="o">=</span> <span class="n">runMap_idx</span> <span class="o">&amp;</span> <span class="n">roiType_idx</span>
			<span class="k">if</span> <span class="n">currSegmentID</span><span class="p">:</span>
				<span class="n">segmentID_idx</span> <span class="o">=</span> <span class="n">orig_df</span><span class="p">[</span><span class="s1">&#39;parentID&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">currSegmentID</span><span class="p">)</span>
				<span class="n">runMap_idx</span> <span class="o">=</span> <span class="n">runMap_idx</span> <span class="o">&amp;</span> <span class="n">segmentID_idx</span>
			<span class="k">if</span> <span class="ow">not</span> <span class="n">pd</span><span class="p">[</span><span class="s1">&#39;plotbad&#39;</span><span class="p">]:</span>
				<span class="n">notBad_idx</span> <span class="o">=</span> <span class="o">~</span><span class="n">orig_df</span><span class="p">[</span><span class="s1">&#39;isBad&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">isin</span><span class="p">([</span><span class="mi">1</span><span class="p">])</span>
				<span class="n">runMap_idx</span> <span class="o">=</span> <span class="n">runMap_idx</span> <span class="o">&amp;</span> <span class="n">notBad_idx</span>

			<span class="c1"># final_df = orig_df.loc[runMap_idx]</span>
			<span class="n">final_df</span> <span class="o">=</span> <span class="n">orig_df</span><span class="o">.</span><span class="n">ix</span><span class="p">[</span><span class="n">runMap_idx</span><span class="p">]</span>

			<span class="n">finalIndexList</span> <span class="o">=</span> <span class="n">final_df</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>

			<span class="c1"># we have a list of valid stack centric index in runMap_idx</span>
			<span class="c1"># reverse this back into run centric to set rows in runMap (xPlot, yPlot)</span>
			<span class="c1"># finalRows = self.objMap[runIdxDim,final_df.index,j]</span>
			<span class="n">finalRows</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">objMap</span><span class="p">[</span><span class="n">runIdxDim</span><span class="p">,</span> <span class="n">finalIndexList</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span>
			<span class="n">finalRows</span> <span class="o">=</span> <span class="n">finalRows</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>

			<span class="c1"># convert to values at end</span>
			<span class="k">try</span><span class="p">:</span>
				<span class="k">if</span> <span class="n">pd</span><span class="p">[</span><span class="s1">&#39;xstat&#39;</span><span class="p">]:</span>
					<span class="n">pd</span><span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">][</span><span class="n">finalRows</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">final_df</span><span class="p">[</span><span class="n">pd</span><span class="p">[</span><span class="s1">&#39;xstat&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">values</span>
				<span class="k">if</span> <span class="n">pd</span><span class="p">[</span><span class="s1">&#39;ystat&#39;</span><span class="p">]:</span>
					<span class="n">pd</span><span class="p">[</span><span class="s1">&#39;y&#39;</span><span class="p">][</span><span class="n">finalRows</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">final_df</span><span class="p">[</span><span class="n">pd</span><span class="p">[</span><span class="s1">&#39;ystat&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">values</span>
				<span class="k">if</span> <span class="n">pd</span><span class="p">[</span><span class="s1">&#39;zstat&#39;</span><span class="p">]:</span>
					<span class="n">pd</span><span class="p">[</span><span class="s1">&#39;z&#39;</span><span class="p">][</span><span class="n">finalRows</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">final_df</span><span class="p">[</span><span class="n">pd</span><span class="p">[</span><span class="s1">&#39;zstat&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">values</span>
			<span class="k">except</span> <span class="ne">KeyError</span><span class="p">,</span> <span class="n">e</span><span class="p">:</span>
				<span class="nb">print</span> <span class="s1">&#39;getMapValues3() KeyError - reason &quot;</span><span class="si">%s</span><span class="s1">&quot;&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>

			<span class="c1"># keep track of stack centric spine idx</span>
			<span class="n">yIdx</span><span class="p">[</span><span class="n">finalRows</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">final_df</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">values</span>
			<span class="n">ySess</span><span class="p">[</span><span class="n">finalRows</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">j</span>
			<span class="n">yRunRow</span><span class="p">[</span><span class="n">finalRows</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">finalRows</span>  <span class="c1"># final_df.index</span>

		<span class="c1"># strip out a nan rows, can&#39;t do this until we have gone through all sessions</span>
		<span class="c1"># makes plotting way faster</span>
		<span class="n">ySess</span> <span class="o">=</span> <span class="n">ySess</span><span class="p">[</span><span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">yIdx</span><span class="p">)</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)]</span>
		<span class="n">yRunRow</span> <span class="o">=</span> <span class="n">yRunRow</span><span class="p">[</span><span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">yIdx</span><span class="p">)</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)]</span>
		<span class="k">if</span> <span class="n">pd</span><span class="p">[</span><span class="s1">&#39;xstat&#39;</span><span class="p">]:</span>
			<span class="n">pd</span><span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">][</span><span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">yIdx</span><span class="p">)</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)]</span>
		<span class="k">if</span> <span class="n">pd</span><span class="p">[</span><span class="s1">&#39;ystat&#39;</span><span class="p">]:</span>
			<span class="n">pd</span><span class="p">[</span><span class="s1">&#39;y&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="p">[</span><span class="s1">&#39;y&#39;</span><span class="p">][</span><span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">yIdx</span><span class="p">)</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)]</span>
		<span class="k">if</span> <span class="n">pd</span><span class="p">[</span><span class="s1">&#39;zstat&#39;</span><span class="p">]:</span>
			<span class="n">pd</span><span class="p">[</span><span class="s1">&#39;z&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="p">[</span><span class="s1">&#39;z&#39;</span><span class="p">][</span><span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">yIdx</span><span class="p">)</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)]</span>
		<span class="n">yIdx</span> <span class="o">=</span> <span class="n">yIdx</span><span class="p">[</span><span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">yIdx</span><span class="p">)</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)]</span> <span class="c1"># do this last</span>

		<span class="n">stopTime</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
		<span class="nb">print</span> <span class="s1">&#39;mmMap.getMapValues3() took&#39;</span><span class="p">,</span> <span class="nb">round</span><span class="p">(</span><span class="n">stopTime</span> <span class="o">-</span> <span class="n">startTime</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span> <span class="s1">&#39;seconds&#39;</span>

		<span class="n">pd</span><span class="p">[</span><span class="s1">&#39;stackidx&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">yIdx</span>
		<span class="n">pd</span><span class="p">[</span><span class="s1">&#39;mapsess&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ySess</span>
		<span class="n">pd</span><span class="p">[</span><span class="s1">&#39;runrow&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">yRunRow</span>
		<span class="k">return</span> <span class="n">pd</span></div>

<div class="viewcode-block" id="mmMap.getMapValues2"><a class="viewcode-back" href="../../pymapmanager.mmMap.html#pymapmanager.mmMap.mmMap.getMapValues2">[docs]</a>	<span class="k">def</span> <span class="nf">getMapValues2</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">stat</span><span class="p">,</span> <span class="n">roiType</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;spineROI&#39;</span><span class="p">],</span> <span class="n">segmentID</span><span class="o">=</span><span class="p">[],</span> <span class="n">plotBad</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">plotIntBad</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
		<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">		Get values of a stack annotation across all stacks in the map.</span>

<span class="sd">		Args:</span>
<span class="sd">			stat (str): The stack annotation to get (corresponds to a column in mmStack.stackdb)</span>
<span class="sd">			roiType (str): xxx</span>
<span class="sd">			segmentID (list): xxx</span>
<span class="sd">			plotBad (boolean): xxx</span>

<span class="sd">		Returns:</span>
<span class="sd">			2D numpy array of stat values. Each row is a run of objects connected across sessions,</span>
<span class="sd">			columns are sessions, each [i][j] is a stat value</span>
<span class="sd">		&quot;&quot;&quot;</span>

		<span class="c1">#if roiType not in ROI_TYPES:</span>
		<span class="c1">#	errStr = &#39;error: mmMap.getMapValues2() stat &quot;&#39; + roiType + &#39;&quot; is not in &#39; + &#39;,&#39;.join(ROI_TYPES)</span>
		<span class="c1">#	raise ValueError(errStr)</span>

		<span class="n">plotDict</span> <span class="o">=</span> <span class="n">newplotdict</span><span class="p">()</span>
		<span class="n">plotDict</span><span class="p">[</span><span class="s1">&#39;roitype&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">roiType</span>
		<span class="n">plotDict</span><span class="p">[</span><span class="s1">&#39;xstat&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">stat</span>
		<span class="n">plotDict</span><span class="p">[</span><span class="s1">&#39;segmentid&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">segmentID</span>
		<span class="n">plotDict</span><span class="p">[</span><span class="s1">&#39;plotbad&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">plotBad</span>
		<span class="n">plotDict</span><span class="p">[</span><span class="s1">&#39;plotIntBad&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">plotIntBad</span>

		<span class="n">plotDict</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getMapValues3</span><span class="p">(</span><span class="n">plotDict</span><span class="p">)</span>

		<span class="k">return</span> <span class="n">plotDict</span><span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">]</span></div>

	<span class="k">def</span> <span class="nf">_buildRunMap</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">theMap</span><span class="p">):</span>
		<span class="sd">&quot;&quot;&quot;Internal function. Converts 3D objMap into a 2D run map. A run map must be float as it uses np.NaN</span>

<span class="sd">		Args:</span>
<span class="sd">			theMap: Either self.objMap or self.segMap</span>

<span class="sd">		Returns:</span>
<span class="sd">			A numpy ndarray run map</span>
<span class="sd">		&quot;&quot;&quot;</span>

		<span class="n">idx</span> <span class="o">=</span> <span class="mi">0</span>
		<span class="nb">next</span> <span class="o">=</span> <span class="mi">1</span>
		<span class="c1">#nexttp = 2</span>
		<span class="n">prev</span> <span class="o">=</span> <span class="mi">3</span>
		<span class="c1">#prevtp = 4</span>
		<span class="n">runIdx</span> <span class="o">=</span> <span class="mi">6</span> <span class="c1">#if this is correct we can build really fast</span>
		<span class="n">m</span> <span class="o">=</span> <span class="n">theMap</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
		<span class="n">n</span> <span class="o">=</span> <span class="n">theMap</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
		<span class="n">k</span> <span class="o">=</span> <span class="n">theMap</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
		<span class="n">numRows</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">count_nonzero</span><span class="p">(</span><span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">theMap</span><span class="p">[</span><span class="n">idx</span><span class="p">,:,</span><span class="mi">0</span><span class="p">]))</span>
		<span class="n">retRunMap</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">([</span><span class="n">numRows</span><span class="p">,</span><span class="n">n</span><span class="p">])</span> <span class="c1">#, dtype=int)</span>
		<span class="n">retRunMap</span><span class="p">[:]</span> <span class="o">=</span> <span class="s1">&#39;nan&#39;</span>

		<span class="n">emptyRow</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span> <span class="n">n</span><span class="p">])</span>
		<span class="n">emptyRow</span><span class="p">[:]</span> <span class="o">=</span> <span class="s1">&#39;nan&#39;</span>

		<span class="n">currRow</span> <span class="o">=</span> <span class="mi">0</span>
		<span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">n</span><span class="p">):</span> <span class="c1">#sessions</span>
			<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">m</span><span class="p">):</span>
				<span class="c1">#retRunMap[i,j] = &#39;nan&#39;</span>
				<span class="k">if</span> <span class="n">theMap</span><span class="p">[</span><span class="n">idx</span><span class="p">,</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span><span class="o">&gt;=</span><span class="mi">0</span><span class="p">:</span>
					<span class="k">pass</span>
				<span class="k">else</span><span class="p">:</span>
					<span class="k">break</span>
				<span class="k">if</span> <span class="n">j</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span>
					<span class="n">currRow</span> <span class="o">=</span> <span class="n">i</span>
					<span class="n">retRunMap</span><span class="p">[</span><span class="n">currRow</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">i</span>
				<span class="k">elif</span> <span class="ow">not</span> <span class="p">(</span><span class="n">theMap</span><span class="p">[</span><span class="n">prev</span><span class="p">,</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span><span class="o">&gt;=</span><span class="mi">0</span><span class="p">):</span>
					<span class="n">currRow</span> <span class="o">+=</span> <span class="mi">1</span>
					<span class="n">retRunMap</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">([</span><span class="n">retRunMap</span><span class="p">,</span> <span class="n">emptyRow</span><span class="p">])</span>
					<span class="n">retRunMap</span><span class="p">[</span><span class="n">currRow</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">i</span>
					<span class="c1">#retRunMap[retRunMap.size[0]-1,:] = &#39;nan&#39;</span>
				<span class="k">else</span><span class="p">:</span>
					<span class="k">continue</span>
				<span class="c1">#retRunMap[currRow,j] = i</span>
				<span class="n">nextNode</span> <span class="o">=</span> <span class="n">theMap</span><span class="p">[</span><span class="nb">next</span><span class="p">,</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span>
				<span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">j</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">n</span><span class="p">):</span>
					<span class="k">if</span> <span class="n">nextNode</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">:</span>
						<span class="n">retRunMap</span><span class="p">[</span><span class="n">currRow</span><span class="p">,</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">nextNode</span>
					<span class="k">else</span><span class="p">:</span>
						<span class="k">break</span>
					<span class="n">nextNode</span> <span class="o">=</span> <span class="n">theMap</span><span class="p">[</span><span class="nb">next</span><span class="p">,</span><span class="nb">int</span><span class="p">(</span><span class="n">nextNode</span><span class="p">),</span><span class="n">k</span><span class="p">]</span>
		<span class="k">return</span> <span class="n">retRunMap</span>

	<span class="k">def</span> <span class="nf">_getStackSegmentID</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mapSegmentNumber</span><span class="p">,</span> <span class="n">sessIdx</span><span class="p">):</span>
		<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">		Given a map centric segment index (row in segRunMap), tell us the stack centric segmentID for session sessIdx</span>

<span class="sd">		Args:</span>
<span class="sd">			mapSegmentNumber (int): Map centric segment index, row in segRunMap</span>
<span class="sd">			sessIdx (int): Session number</span>

<span class="sd">		Returns: int or nan: Stack centric segmentID or None if no corresponding segment in that session.</span>
<span class="sd">		&quot;&quot;&quot;</span>
		<span class="n">stackSegment</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
		<span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">segRunMap</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
			<span class="n">stackSegment</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">segRunMap</span><span class="p">[</span><span class="n">mapSegmentNumber</span><span class="p">][</span><span class="n">sessIdx</span><span class="p">]</span> <span class="c1"># can be nan</span>
		<span class="k">if</span> <span class="n">math</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">stackSegment</span><span class="p">):</span>
			<span class="k">return</span> <span class="kc">None</span>
		<span class="k">else</span><span class="p">:</span>
			<span class="k">return</span> <span class="n">stackSegment</span></div>

<div class="viewcode-block" id="testmmMap"><a class="viewcode-back" href="../../pymapmanager.mmMap.html#pymapmanager.mmMap.testmmMap">[docs]</a><span class="k">class</span> <span class="nc">testmmMap</span><span class="p">():</span>
	<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">	docstring for testmmMap</span>
<span class="sd">	&quot;&quot;&quot;</span>
	<span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
		<span class="k">pass</span></div>
</pre></div>

           </div>
           <div class="articleComments">
            
           </div>
          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2017, Robert H Cudmore.

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/snide/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  

    <script type="text/javascript">
        var DOCUMENTATION_OPTIONS = {
            URL_ROOT:'../../',
            VERSION:'a1',
            COLLAPSE_INDEX:false,
            FILE_SUFFIX:'.html',
            HAS_SOURCE:  true,
            SOURCELINK_SUFFIX: ''
        };
    </script>
      <script type="text/javascript" src="../../_static/jquery.js"></script>
      <script type="text/javascript" src="../../_static/underscore.js"></script>
      <script type="text/javascript" src="../../_static/doctools.js"></script>

  

  
  
    <script type="text/javascript" src="../../_static/js/theme.js"></script>
  

  
  
  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.StickyNav.enable();
      });
  </script>
   

</body>
</html>