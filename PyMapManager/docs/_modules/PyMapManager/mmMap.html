<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>PyMapManager.mmMap &#8212; PyMapManager a0 documentation</title>
    
    <link rel="stylesheet" href="../../_static/alabaster.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../../',
        VERSION:     'a0',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true,
        SOURCELINK_SUFFIX: '.txt'
      };
    </script>
    <script type="text/javascript" src="../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../_static/doctools.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
   
  <link rel="stylesheet" href="../../_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head>
  <body role="document">
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <h1>Source code for PyMapManager.mmMap</h1><div class="highlight"><pre>
<span></span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">This is for mmMap module</span>

<span class="sd">	Examples:</span>
<span class="sd">		xxx</span>
<span class="sd">		yyy</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="kn">import</span> <span class="nn">os</span><span class="o">,</span> <span class="nn">time</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>

<span class="kn">import</span> <span class="nn">PyMapManager</span>
<span class="kn">from</span> <span class="nn">PyMapManager.mmUtil</span> <span class="k">import</span> <span class="n">ROI_TYPES</span><span class="p">,</span> <span class="n">STACK_STATS</span><span class="p">,</span> <span class="n">newplotstruct</span>
<span class="kn">from</span> <span class="nn">PyMapManager.mmStack</span> <span class="k">import</span> <span class="n">mmStack</span>

<span class="c1">#import logging</span>
<span class="c1">#logging.basicConfig(filename=&#39;example.log&#39;,level=logging.DEBUG)</span>

<div class="viewcode-block" id="mmMap"><a class="viewcode-back" href="../../PyMapManager.html#PyMapManager.mmMap.mmMap">[docs]</a><span class="k">class</span> <span class="nc">mmMap</span><span class="p">():</span>
	<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">	A map is a list of :class:`PyMapManager.mmStack` and an object map that connects annotations (spines) sequentially from one stack to the next.</span>

<span class="sd">	Args:</span>
<span class="sd">		filePath (str): Full file path to .txt file for the map. File is inside map folder, for map a5n it is /a5n/a5n.txt</span>

<span class="sd">	Example::</span>

<span class="sd">		from mmMap import mmMap</span>
<span class="sd">		file = &#39;/Users/cudmore/Desktop/data/rr30a/rr30a.txt&#39;</span>
<span class="sd">		m = mmMap(filePath=path)</span>

<span class="sd">	Once created and populated with stack, get the ith mmStack using::</span>

<span class="sd">		stack = m.stacks[i]</span>

<span class="sd">	Use getMapValues2() to retrieve stack statistics (for the given segmentID) across the entire map::</span>

<span class="sd">		pDist_values = m.getMapValues2(&#39;pDist&#39;, segmentID=[3])</span>

<span class="sd">	&quot;&quot;&quot;</span>

	<span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filePath</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">):</span>

		<span class="c1">#logging.debug(&#39;mmMap.__init__() filePath:&#39; + filePath)</span>
		<span class="c1">#self.log = logging.getLogger(self.__class__.__name__)</span>
		<span class="c1">#self.log.info(&quot;constructor&quot;)</span>

		<span class="bp">self</span><span class="o">.</span><span class="n">defaultRoiType</span> <span class="o">=</span> <span class="s1">&#39;spineROI&#39;</span>

		<span class="n">startTime</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>

		<span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">filePath</span><span class="p">):</span>
			<span class="nb">print</span> <span class="s1">&#39;mmMap() error, file not found:&#39;</span><span class="p">,</span> <span class="n">filePath</span>
			<span class="k">return</span>

		<span class="bp">self</span><span class="o">.</span><span class="n">filePath</span> <span class="o">=</span> <span class="n">filePath</span>
		<span class="sd">&quot;&quot;&quot;Path to file used to open map.&quot;&quot;&quot;</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">folder</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">filePath</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;/&#39;</span>
		<span class="sd">&quot;&quot;&quot;Path to enclosing folder, ends in &#39;/&#39;.&quot;&quot;&quot;</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">filePath</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s1">&#39;.txt&#39;</span><span class="p">)</span>  <span class="c1"># map name</span>
		<span class="sd">&quot;&quot;&quot;name of the map, for a map loaded with file a5n.txt, the name is a5b. Same as enclosing folder name.&quot;&quot;&quot;</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">table</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_table</span><span class="p">(</span><span class="n">filePath</span><span class="p">,</span> <span class="n">index_col</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
		<span class="sd">&quot;&quot;&quot;Pandas df loaded from filePath. Get values using getValue(name,session)&quot;&quot;&quot;</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">numChannels</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getValue</span><span class="p">(</span><span class="s1">&#39;numChannels&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
		<span class="sd">&quot;&quot;&quot;Number of image channels in each stack (must be the same for all stacks).&quot;&quot;&quot;</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">numSessions</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">table</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="s1">&#39;hsStack&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">count</span><span class="p">()</span>
		<span class="sd">&quot;&quot;&quot;Number of sessions in the map.&quot;&quot;&quot;</span>

		<span class="sd">&quot;&quot;&quot;3D numpy array, rows are stack centric indices, columns are sessions, 3rd dimension is:</span>
<span class="sd">		    [0] idx, [1] next, [2] nextTP, [3] prev, [4] prevTP</span>
<span class="sd">		    [5] blank, [6] runIdx, [7] dynType, [8] forced</span>
<span class="sd">		    [9] nodeType, [10] segmentID, [11] splitIdx</span>
<span class="sd">		&quot;&quot;&quot;</span>

		<span class="c1"># objMap (3d)</span>
		<span class="n">objMapFile</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">folder</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">+</span> <span class="s1">&#39;_objMap.txt&#39;</span>
		<span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">objMapFile</span><span class="p">,</span> <span class="s1">&#39;rU&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
			<span class="n">header</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span><span class="o">.</span><span class="n">rstrip</span><span class="p">()</span>
			<span class="k">if</span> <span class="n">header</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;;&#39;</span><span class="p">):</span>
				<span class="n">header</span> <span class="o">=</span> <span class="n">header</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
			<span class="n">header</span> <span class="o">=</span> <span class="n">header</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;;&#39;</span><span class="p">)</span>
			<span class="n">d</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;=&#39;</span><span class="p">)</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">header</span><span class="p">)</span>
			<span class="n">numRow</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">d</span><span class="p">[</span><span class="s1">&#39;rows&#39;</span><span class="p">])</span>
			<span class="n">numCol</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">d</span><span class="p">[</span><span class="s1">&#39;cols&#39;</span><span class="p">])</span>
			<span class="n">numBlock</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">d</span><span class="p">[</span><span class="s1">&#39;blocks&#39;</span><span class="p">])</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">objMap</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">loadtxt</span><span class="p">(</span><span class="n">objMapFile</span><span class="p">,</span> <span class="n">skiprows</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">objMap</span><span class="o">.</span><span class="n">resize</span><span class="p">(</span><span class="n">numBlock</span><span class="p">,</span><span class="n">numRow</span><span class="p">,</span><span class="n">numCol</span><span class="p">)</span>

		<span class="bp">self</span><span class="o">.</span><span class="n">runMap</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_buildRunMap</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">objMap</span><span class="p">)</span>

		<span class="c1"># segMap (3d)</span>
		<span class="n">segMapFile</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">folder</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">+</span> <span class="s1">&#39;_segMap.txt&#39;</span>
		<span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">segMapFile</span><span class="p">,</span> <span class="s1">&#39;rU&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
			<span class="n">header</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span><span class="o">.</span><span class="n">rstrip</span><span class="p">()</span>
			<span class="k">if</span> <span class="n">header</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;;&#39;</span><span class="p">):</span>
				<span class="n">header</span> <span class="o">=</span> <span class="n">header</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
			<span class="n">header</span> <span class="o">=</span> <span class="n">header</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;;&#39;</span><span class="p">)</span>
			<span class="n">d</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;=&#39;</span><span class="p">)</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">header</span><span class="p">)</span>
			<span class="n">numRow</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">d</span><span class="p">[</span><span class="s1">&#39;rows&#39;</span><span class="p">])</span>
			<span class="n">numCol</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">d</span><span class="p">[</span><span class="s1">&#39;cols&#39;</span><span class="p">])</span>
			<span class="n">numBlock</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">d</span><span class="p">[</span><span class="s1">&#39;blocks&#39;</span><span class="p">])</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">segMap</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">loadtxt</span><span class="p">(</span><span class="n">segMapFile</span><span class="p">,</span> <span class="n">skiprows</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">segMap</span><span class="o">.</span><span class="n">resize</span><span class="p">(</span><span class="n">numBlock</span><span class="p">,</span><span class="n">numRow</span><span class="p">,</span><span class="n">numCol</span><span class="p">)</span>

		<span class="bp">self</span><span class="o">.</span><span class="n">segRunMap</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_buildRunMap</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">segMap</span><span class="p">)</span>

		<span class="c1">#load each stack db</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">stacks</span> <span class="o">=</span> <span class="p">[]</span>
		<span class="sd">&quot;&quot;&quot;A list of mmStack&quot;&quot;&quot;</span>
		<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">numSessions</span><span class="p">):</span>
			<span class="n">stack</span> <span class="o">=</span> <span class="n">mmStack</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">getStackName</span><span class="p">(</span><span class="n">i</span><span class="p">),</span> <span class="n">numChannels</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">numChannels</span><span class="p">,</span> <span class="nb">map</span><span class="o">=</span><span class="bp">self</span><span class="p">,</span> <span class="n">mapSession</span><span class="o">=</span><span class="n">i</span><span class="p">)</span>

			<span class="c1">#numObj = stack.numObj()</span>

			<span class="bp">self</span><span class="o">.</span><span class="n">stacks</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">stack</span><span class="p">)</span>

			<span class="c1">#all stackdb into single pandas dataframe</span>
			<span class="c1">#need to offset (next, prev)</span>

			<span class="c1">#add nearest neighbor analysis?</span>


		<span class="n">stopTime</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
		<span class="nb">print</span> <span class="s1">&#39;map&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="s1">&#39;loaded in&#39;</span><span class="p">,</span> <span class="nb">round</span><span class="p">(</span><span class="n">stopTime</span><span class="o">-</span><span class="n">startTime</span><span class="p">,</span><span class="mi">2</span><span class="p">),</span> <span class="s1">&#39;seconds.&#39;</span>

<div class="viewcode-block" id="mmMap.getValue"><a class="viewcode-back" href="../../PyMapManager.html#PyMapManager.mmMap.mmMap.getValue">[docs]</a>	<span class="k">def</span> <span class="nf">getValue</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">sessionNumber</span><span class="p">):</span>
		<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">		Get a value from the map (not from a stack!).</span>

<span class="sd">		Args:</span>
<span class="sd">		    name: Name of map stat</span>
<span class="sd">		    sessionNumber: Session number</span>

<span class="sd">		Returns:</span>
<span class="sd">		    Str (this is a single value)</span>

<span class="sd">		Examples::</span>

<span class="sd">		    m.getValue(&#39;voxelx&#39;, 5) # get the x voxel size of stack 5 (in um/pixel)</span>
<span class="sd">		    m.getValue(&#39;hsStack&#39;,3) # get the name of stack 3</span>
<span class="sd">		&quot;&quot;&quot;</span>
		<span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">table</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">name</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">sessionNumber</span><span class="p">]</span> <span class="c1"># .loc specifies row, .iloc specifies a column</span></div>

<div class="viewcode-block" id="mmMap.getStackName"><a class="viewcode-back" href="../../PyMapManager.html#PyMapManager.mmMap.mmMap.getStackName">[docs]</a>	<span class="k">def</span> <span class="nf">getStackName</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sess</span><span class="p">):</span>
		<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">		Args:</span>
<span class="sd">			sess: Session number</span>

<span class="sd">		Return: stack name as str</span>
<span class="sd">		&quot;&quot;&quot;</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getValue</span><span class="p">(</span><span class="s1">&#39;hsStack&#39;</span><span class="p">,</span> <span class="n">sess</span><span class="p">)</span>
		<span class="k">if</span> <span class="n">ret</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;_ch1&#39;</span><span class="p">):</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">ret</span><span class="p">[:</span><span class="o">-</span><span class="mi">4</span><span class="p">]</span>
		<span class="k">return</span> <span class="n">ret</span></div>

<div class="viewcode-block" id="mmMap.getMapValues2"><a class="viewcode-back" href="../../PyMapManager.html#PyMapManager.mmMap.mmMap.getMapValues2">[docs]</a>	<span class="k">def</span> <span class="nf">getMapValues2</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">stat</span><span class="p">,</span> <span class="n">roiType</span><span class="o">=</span><span class="s1">&#39;spineROI&#39;</span><span class="p">,</span> <span class="n">segmentID</span><span class="o">=</span><span class="p">[],</span> <span class="n">plotBad</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
		<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">		Get values of a stack statistic across all stacks in the map</span>

<span class="sd">		Args:</span>
<span class="sd">		    stat (str): The stack statistic to get (corresponds to a column in mmStack.stackdb)</span>
<span class="sd">			roiType (str): xxx</span>
<span class="sd">			segmentID (list): xxx</span>
<span class="sd">			plotBad (boolean): xxx</span>

<span class="sd">		Returns:</span>
<span class="sd">		    2D numpy array of stat values. Each row is a run of objects connected across sessions, columns are sessions, each [i][j] is a stat value</span>
<span class="sd">		&quot;&quot;&quot;</span>

		<span class="k">if</span> <span class="n">roiType</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">ROI_TYPES</span><span class="p">:</span>
			<span class="nb">print</span> <span class="s1">&#39;error: mmMap.getMapValues2() stat&#39;</span><span class="p">,</span> <span class="n">stat</span><span class="p">,</span> <span class="s1">&#39;is not in&#39;</span><span class="p">,</span> <span class="n">ROI_TYPES</span>
			<span class="k">return</span>

		<span class="n">d</span> <span class="o">=</span> <span class="n">newplotstruct</span><span class="p">()</span>
		<span class="n">d</span><span class="p">[</span><span class="s1">&#39;xstat&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">stat</span>
		<span class="n">d</span><span class="p">[</span><span class="s1">&#39;ystat&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
		<span class="n">d</span><span class="p">[</span><span class="s1">&#39;roiType&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">roiType</span>
		<span class="n">d</span><span class="p">[</span><span class="s1">&#39;segmentID&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">segmentID</span>
		<span class="n">d</span><span class="p">[</span><span class="s1">&#39;plotBad&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">plotBad</span>

		<span class="n">xPlot</span><span class="p">,</span> <span class="n">yPlot</span><span class="p">,</span> <span class="n">yIdx</span><span class="p">,</span> <span class="n">ySess</span><span class="p">,</span> <span class="n">yRunRow</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getMapValues</span><span class="p">(</span><span class="n">d</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">xPlot</span></div>

<div class="viewcode-block" id="mmMap.getMapValues"><a class="viewcode-back" href="../../PyMapManager.html#PyMapManager.mmMap.mmMap.getMapValues">[docs]</a>	<span class="k">def</span> <span class="nf">getMapValues</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">d</span><span class="p">,</span> <span class="n">flatten</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
		<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">		Get values of a stack statistic across all stacks in the map</span>

<span class="sd">		Args:</span>
<span class="sd">		    d (dict): Dictionary specifying parameters for the plot. See PyMApManager.PLOT_STRUCT</span>
<span class="sd">			flatten (boolean): On return flatten 2D into 1D</span>

<span class="sd">		Returns:</span>
<span class="sd">		    (xPlot,yPlot, yIdx, ySess, yRunRow) which are all 2D numpy array</span>
<span class="sd">		&quot;&quot;&quot;</span>
		<span class="n">startTime</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>

		<span class="n">roiType</span> <span class="o">=</span> <span class="n">d</span><span class="p">[</span><span class="s1">&#39;roiType&#39;</span><span class="p">]</span>
		<span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">roiType</span><span class="p">)</span> <span class="o">!=</span> <span class="s1">&#39;list&#39;</span><span class="p">:</span>
			<span class="n">roiType</span> <span class="o">=</span> <span class="p">[</span><span class="n">roiType</span><span class="p">]</span>
		<span class="n">segmentID</span> <span class="o">=</span> <span class="n">d</span><span class="p">[</span><span class="s1">&#39;segmentID&#39;</span><span class="p">]</span>
		<span class="n">plotBad</span> <span class="o">=</span> <span class="n">d</span><span class="p">[</span><span class="s1">&#39;plotBad&#39;</span><span class="p">]</span>
		<span class="n">ystat</span> <span class="o">=</span> <span class="n">d</span><span class="p">[</span><span class="s1">&#39;ystat&#39;</span><span class="p">]</span>
		<span class="n">xstat</span> <span class="o">=</span> <span class="n">d</span><span class="p">[</span><span class="s1">&#39;xstat&#39;</span><span class="p">]</span>

		<span class="n">m</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">runMap</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
		<span class="n">n</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">runMap</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>

		<span class="n">yPlot</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">([</span><span class="n">m</span><span class="p">,</span> <span class="n">n</span><span class="p">])</span>
		<span class="n">xPlot</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">([</span><span class="n">m</span><span class="p">,</span> <span class="n">n</span><span class="p">])</span>
		<span class="n">yPlot</span><span class="p">[:]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">NAN</span>
		<span class="n">xPlot</span><span class="p">[:]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">NAN</span>

		<span class="c1"># keep track of stack centric index we are plotting</span>
		<span class="n">yIdx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">([</span><span class="n">m</span><span class="p">,</span> <span class="n">n</span><span class="p">])</span>
		<span class="n">yIdx</span><span class="p">[:]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">NAN</span>

		<span class="c1"># keep track of session index</span>
		<span class="n">ySess</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">([</span><span class="n">m</span><span class="p">,</span> <span class="n">n</span><span class="p">])</span>
		<span class="n">ySess</span><span class="p">[:]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">NAN</span>

		<span class="c1"># keep track of run map rows (we already know the session/column)</span>
		<span class="n">yRunRow</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">([</span><span class="n">m</span><span class="p">,</span><span class="n">n</span><span class="p">])</span>
		<span class="n">yRunRow</span><span class="p">[:]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">NAN</span>

		<span class="n">runIdxDim</span> <span class="o">=</span> <span class="mi">6</span>

		<span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
			<span class="n">orig_df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">stacks</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">stackdb</span>

			<span class="n">currSegmentID</span> <span class="o">=</span> <span class="p">[]</span>
			<span class="k">if</span> <span class="n">segmentID</span><span class="p">:</span>
				<span class="n">currSegmentID</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">segRunMap</span><span class="p">[</span><span class="n">segmentID</span><span class="p">,</span><span class="n">j</span><span class="p">]</span> <span class="c1">#this only works for one segment -- NOT A LIST</span>
				<span class="n">currSegmentID</span> <span class="o">=</span> <span class="n">currSegmentID</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
			<span class="k">if</span> <span class="n">segmentID</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">currSegmentID</span><span class="p">:</span>
				<span class="c1">#this session does not have segmentID that match</span>
				<span class="k">break</span>

			<span class="n">goodIdx</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">runMap</span><span class="p">[:,</span> <span class="n">j</span><span class="p">]</span> <span class="c1"># valid indices from runMap</span>

			<span class="n">runMap_idx</span> <span class="o">=</span> <span class="n">orig_df</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">goodIdx</span><span class="p">)</span> <span class="c1"># series of boolean (Seems to play nice with nparray)</span>

			<span class="k">if</span> <span class="n">roiType</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
				<span class="n">roiType_idx</span> <span class="o">=</span> <span class="n">orig_df</span><span class="p">[</span><span class="s1">&#39;roiType&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">roiType</span><span class="p">)</span>
				<span class="n">runMap_idx</span> <span class="o">=</span> <span class="n">runMap_idx</span> <span class="o">&amp;</span> <span class="n">roiType_idx</span>
			<span class="k">if</span> <span class="n">currSegmentID</span><span class="p">:</span>
				<span class="n">segmentID_idx</span> <span class="o">=</span> <span class="n">orig_df</span><span class="p">[</span><span class="s1">&#39;parentID&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">currSegmentID</span><span class="p">)</span>
				<span class="n">runMap_idx</span> <span class="o">=</span> <span class="n">runMap_idx</span> <span class="o">&amp;</span> <span class="n">segmentID_idx</span>
			<span class="k">if</span> <span class="ow">not</span> <span class="n">plotBad</span><span class="p">:</span>
				<span class="n">notBad_idx</span> <span class="o">=</span> <span class="o">~</span><span class="n">orig_df</span><span class="p">[</span><span class="s1">&#39;isBad&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">isin</span><span class="p">([</span><span class="mi">1</span><span class="p">])</span>
				<span class="n">runMap_idx</span> <span class="o">=</span> <span class="n">runMap_idx</span> <span class="o">&amp;</span> <span class="n">notBad_idx</span>

			<span class="c1">#final_df = orig_df.loc[runMap_idx]</span>
			<span class="n">final_df</span> <span class="o">=</span> <span class="n">orig_df</span><span class="o">.</span><span class="n">ix</span><span class="p">[</span><span class="n">runMap_idx</span><span class="p">]</span>

			<span class="c1">### final_df.index is giving repeats --&gt;&gt; causing finalRows to be missing 44 and has 45 repeated 4 times</span>
			<span class="n">finalIndexList</span> <span class="o">=</span> <span class="n">final_df</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>

			<span class="c1"># #we have a list of valid stack centric index in runMap_idx</span>
			<span class="c1"># reverse this back into run centric to set rows in runMap (xPlot, yPlot)</span>
			<span class="c1">#finalRows = self.objMap[runIdxDim,final_df.index,j]</span>
			<span class="n">finalRows</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">objMap</span><span class="p">[</span><span class="n">runIdxDim</span><span class="p">,</span><span class="n">finalIndexList</span><span class="p">,</span><span class="n">j</span><span class="p">]</span>
			<span class="n">finalRows</span> <span class="o">=</span> <span class="n">finalRows</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>

			<span class="c1"># convert to values at end</span>
			<span class="n">xPlot</span><span class="p">[</span><span class="n">finalRows</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">final_df</span><span class="p">[</span><span class="n">xstat</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
			<span class="k">if</span> <span class="n">ystat</span><span class="p">:</span>
				<span class="n">yPlot</span><span class="p">[</span><span class="n">finalRows</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">final_df</span><span class="p">[</span><span class="n">ystat</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>

			<span class="c1"># keep track of stack centric spine idx</span>
			<span class="n">yIdx</span><span class="p">[</span><span class="n">finalRows</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">final_df</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">values</span>
			<span class="n">ySess</span><span class="p">[</span><span class="n">finalRows</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">j</span>
			<span class="n">yRunRow</span><span class="p">[</span><span class="n">finalRows</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">finalRows</span> <span class="c1">#final_df.index</span>

			<span class="k">if</span> <span class="n">j</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span>
				<span class="n">tmp_m</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">finalRows</span><span class="p">)</span>
				<span class="k">for</span> <span class="n">tmp_i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">tmp_m</span><span class="p">):</span>
					<span class="c1">#print tmp_i, finalRows[tmp_i]</span>
					<span class="k">pass</span>

		<span class="n">stopTime</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
		<span class="nb">print</span> <span class="s1">&#39;mmMap.getMapValues() took&#39;</span><span class="p">,</span> <span class="nb">round</span><span class="p">(</span><span class="n">stopTime</span> <span class="o">-</span> <span class="n">startTime</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span> <span class="s1">&#39;seconds&#39;</span>

		<span class="k">if</span> <span class="n">flatten</span><span class="p">:</span>
			<span class="n">xPlot</span> <span class="o">=</span> <span class="n">xPlot</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
			<span class="n">yPlot</span> <span class="o">=</span> <span class="n">yPlot</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
			<span class="n">yIdx</span> <span class="o">=</span> <span class="n">yIdx</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
			<span class="n">ySess</span> <span class="o">=</span> <span class="n">ySess</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
			<span class="n">yRunRow</span> <span class="o">=</span> <span class="n">yRunRow</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>

		<span class="k">return</span> <span class="n">xPlot</span><span class="p">,</span><span class="n">yPlot</span><span class="p">,</span> <span class="n">yIdx</span><span class="p">,</span> <span class="n">ySess</span><span class="p">,</span> <span class="n">yRunRow</span></div>

<div class="viewcode-block" id="mmMap.getNumSegments"><a class="viewcode-back" href="../../PyMapManager.html#PyMapManager.mmMap.mmMap.getNumSegments">[docs]</a>	<span class="k">def</span> <span class="nf">getNumSegments</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
		<span class="n">numSegments</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">segMap</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
		<span class="k">return</span> <span class="n">numSegments</span></div>

	<span class="k">def</span> <span class="nf">_buildRunMap</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">theMap</span><span class="p">):</span>
		<span class="sd">&quot;&quot;&quot;Internal function. Converts 3D objMap into a 2D run map. A run map must be float as it uses np.NaN</span>

<span class="sd">		theMap: Either self.objMap or self.segMap</span>
<span class="sd">		&quot;&quot;&quot;</span>

		<span class="n">idx</span> <span class="o">=</span> <span class="mi">0</span>
		<span class="nb">next</span> <span class="o">=</span> <span class="mi">1</span>
		<span class="c1">#nexttp = 2</span>
		<span class="n">prev</span> <span class="o">=</span> <span class="mi">3</span>
		<span class="c1">#prevtp = 4</span>
		<span class="n">runIdx</span> <span class="o">=</span> <span class="mi">6</span> <span class="c1">#if this is correct we can build really fast</span>
		<span class="n">m</span> <span class="o">=</span> <span class="n">theMap</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
		<span class="n">n</span> <span class="o">=</span> <span class="n">theMap</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
		<span class="n">k</span> <span class="o">=</span> <span class="n">theMap</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
		<span class="n">numRows</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">count_nonzero</span><span class="p">(</span><span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">theMap</span><span class="p">[</span><span class="n">idx</span><span class="p">,:,</span><span class="mi">0</span><span class="p">]))</span>
		<span class="n">retRunMap</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">([</span><span class="n">numRows</span><span class="p">,</span><span class="n">n</span><span class="p">])</span> <span class="c1">#, dtype=int)</span>
		<span class="n">retRunMap</span><span class="p">[:]</span> <span class="o">=</span> <span class="s1">&#39;nan&#39;</span>

		<span class="n">emptyRow</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span> <span class="n">n</span><span class="p">])</span>
		<span class="n">emptyRow</span><span class="p">[:]</span> <span class="o">=</span> <span class="s1">&#39;nan&#39;</span>

		<span class="n">currRow</span> <span class="o">=</span> <span class="mi">0</span>
		<span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">n</span><span class="p">):</span> <span class="c1">#sessions</span>
			<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">m</span><span class="p">):</span>
				<span class="c1">#retRunMap[i,j] = &#39;nan&#39;</span>
				<span class="k">if</span> <span class="n">theMap</span><span class="p">[</span><span class="n">idx</span><span class="p">,</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span><span class="o">&gt;=</span><span class="mi">0</span><span class="p">:</span>
					<span class="k">pass</span>
				<span class="k">else</span><span class="p">:</span>
					<span class="k">break</span>
				<span class="k">if</span> <span class="n">j</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span>
					<span class="n">currRow</span> <span class="o">=</span> <span class="n">i</span>
					<span class="n">retRunMap</span><span class="p">[</span><span class="n">currRow</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">i</span>
				<span class="k">elif</span> <span class="ow">not</span> <span class="p">(</span><span class="n">theMap</span><span class="p">[</span><span class="n">prev</span><span class="p">,</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span><span class="o">&gt;=</span><span class="mi">0</span><span class="p">):</span>
					<span class="n">currRow</span> <span class="o">+=</span> <span class="mi">1</span>
					<span class="n">retRunMap</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">([</span><span class="n">retRunMap</span><span class="p">,</span> <span class="n">emptyRow</span><span class="p">])</span>
					<span class="n">retRunMap</span><span class="p">[</span><span class="n">currRow</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">i</span>
					<span class="c1">#retRunMap[retRunMap.size[0]-1,:] = &#39;nan&#39;</span>
				<span class="k">else</span><span class="p">:</span>
					<span class="k">continue</span>
				<span class="c1">#retRunMap[currRow,j] = i</span>
				<span class="n">nextNode</span> <span class="o">=</span> <span class="n">theMap</span><span class="p">[</span><span class="nb">next</span><span class="p">,</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span>
				<span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">j</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">n</span><span class="p">):</span>
					<span class="k">if</span> <span class="n">nextNode</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">:</span>
						<span class="n">retRunMap</span><span class="p">[</span><span class="n">currRow</span><span class="p">,</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">nextNode</span>
					<span class="k">else</span><span class="p">:</span>
						<span class="k">break</span>
					<span class="n">nextNode</span> <span class="o">=</span> <span class="n">theMap</span><span class="p">[</span><span class="nb">next</span><span class="p">,</span><span class="nb">int</span><span class="p">(</span><span class="n">nextNode</span><span class="p">),</span><span class="n">k</span><span class="p">]</span>
		<span class="k">return</span> <span class="n">retRunMap</span></div>
</pre></div>

          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper"><div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="../../index.html">Documentation overview</a><ul>
  <li><a href="../index.html">Module code</a><ul>
  </ul></li>
  </ul></li>
</ul>
</div>
<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <form class="search" action="../../search.html" method="get">
      <div><input type="text" name="q" /></div>
      <div><input type="submit" value="Go" /></div>
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;2017, RHC.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 1.5.6</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.10</a>
      
    </div>

    

    
  </body>
</html>